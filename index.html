<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To-Do List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    input:focus, button:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }
    #right-sidebar {
      position: fixed;
      top: 48px;
      right: 32px;
      height: auto;
      min-height: 500px;
      max-height: 86vh;
      width: 340px;
      background: #f8f9fa;
      box-shadow: 0 6px 32px 0 rgba(60,72,85,.08), 0 1.5px 6px 0 rgba(60,72,85,.04);
      border-radius: 22px;
      z-index: 50;
      padding: 28px 18px 26px 26px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      transition: background 0.3s;
      border: 1.5px solid #e0e5ee;
    }
    .dark #right-sidebar {
      background: #181f2a;
      color: #fff;
      border: 1.5px solid #222b38;
      box-shadow: 0 6px 32px 0 rgba(23,25,35,.11), 0 1.5px 6px 0 rgba(60,72,85,.07);
    }
    @media (max-width: 1100px) {
      #right-sidebar {
        position: static;
        width: 100%;
        height: auto;
        min-height: unset;
        max-height: none;
        box-shadow: none;
        border-radius: 16px;
        margin: 0 auto 24px auto;
        right: 0;
        top: 0;
      }
    }
    .sidebar-alarm-list::-webkit-scrollbar {
      width: 8px;
    }
    .sidebar-alarm-list::-webkit-scrollbar-thumb {
      background: #dee2e6;
      border-radius: 3px;
    }
    @media (min-width: 1100px) {
      .main-app-layout {
        margin-right: 400px !important;
      }
    }
    .dark .task-completed-deepblue {
      background-color: #102542 !important;
      color: #c7d0e5 !important;
    }
    .dark .task-completed-deepblue .completed-text {
      color: #e0e6ed !important;
      text-decoration: line-through 2px !important;
      opacity: 1 !important;
    }
    .task-completed-deepblue .completed-text {
      color: #48618a !important;
      text-decoration: line-through 2px !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-200 dark:from-gray-900 dark:to-gray-800 min-h-screen py-10 transition-colors duration-300">
  <div class="main-app-layout max-w-2xl mx-auto p-6 shadow-lg rounded-2xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white" style="margin-right:400px;">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl font-extrabold flex items-center" style="font-family:Montserrat,sans-serif;">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4dd.png" alt="To-Do" style="width:40px;height:40px;margin-right:10px">
        To-Do List
      </h1>
      <button id="dark-toggle" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-800 text-sm text-black dark:text-white">Toggle Dark Mode</button>
    </div>

    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <input id="task-title" type="text" placeholder="Task title" class="border border-gray-300 px-3 py-2 rounded w-full bg-white dark:bg-gray-800 text-black dark:text-white placeholder-gray-500">
      <input id="task-date" type="date" class="border border-gray-300 px-3 py-2 rounded bg-white dark:bg-gray-800 text-black dark:text-white">
      <select id="task-priority" class="border border-gray-300 px-3 py-2 rounded bg-white dark:bg-gray-800 text-black dark:text-white">
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
      <select id="task-recurring" class="border border-gray-300 px-3 py-2 rounded bg-white dark:bg-gray-800 text-black dark:text-white">
        <option value="none">Once</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
      </select>
      <button id="add-task" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Add</button>
    </div>

    <div class="flex justify-between gap-2 mb-4">
      <select id="filter-priority" class="border px-3 py-1 rounded w-1/2 bg-white dark:bg-gray-800 text-black dark:text-white">
        <option value="all">All Priorities</option>
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
      <input id="filter-date" type="date" class="border px-3 py-1 rounded w-1/2 bg-white dark:bg-gray-800 text-black dark:text-white">
    </div>

    <ul id="task-list" class="space-y-3 custom-scrollbar max-h-[400px] overflow-y-auto"></ul>
  </div>

  <!-- Right Sidebar -->
  <div id="right-sidebar" class="dark:bg-gray-900 dark:text-white">
    <h2 class="text-xl font-bold text-center mb-4 flex items-center justify-center" style="font-family:Montserrat,sans-serif;">
      <span style="font-size:1.4em;margin-right:7px;">&#128721;</span>
      Time & Alarms
    </h2>
    <div id="current-time" class="text-3xl font-mono text-center mb-6 select-none tracking-wider"></div>
    <form id="alarm-form" class="mb-4">
      <div class="flex flex-col gap-2">
        <div>
          <label class="block text-sm mb-1">Date & Time</label>
          <input id="alarm-date" type="date" required class="border px-2 py-1 rounded w-full mb-2 bg-white dark:bg-gray-800 text-black dark:text-white">
          <div class="flex gap-2">
            <select id="alarm-hour" class="border px-2 py-1 rounded w-1/3 bg-white dark:bg-gray-800 text-black dark:text-white"></select>
            <span class="self-center text-gray-500">:</span>
            <select id="alarm-minute" class="border px-2 py-1 rounded w-1/3 bg-white dark:bg-gray-800 text-black dark:text-white"></select>
            <select id="alarm-ampm" class="border px-2 py-1 rounded w-1/3 bg-white dark:bg-gray-800 text-black dark:text-white">
              <option value="AM">AM</option>
              <option value="PM">PM</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Label</label>
          <input id="alarm-label" type="text" class="border px-2 py-1 rounded w-full bg-white dark:bg-gray-800 text-black dark:text-white" placeholder="Alarm label (optional)">
        </div>
        <button type="submit" id="alarm-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mt-2">Add Alarm</button>
        <button type="button" id="alarm-cancel-btn" class="bg-gray-300 text-black px-3 py-1 rounded mt-2 hidden">Cancel</button>
      </div>
    </form>
    <div>
      <h3 class="text-lg font-semibold mb-2">Alarms</h3>
      <ul id="alarm-list" class="sidebar-alarm-list max-h-[320px] overflow-y-auto space-y-2"></ul>
    </div>
  </div>

  <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

  <script>
    // --- Alarm Dropdowns ---
    function populateDropdown(id, from, to, pad=false) {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      for(let i=from; i<=to; ++i){
        const val = pad ? String(i).padStart(2, '0') : String(i);
        sel.innerHTML += `<option value="${val}">${val}</option>`;
      }
    }
    populateDropdown('alarm-hour', 1, 12);
    populateDropdown('alarm-minute', 0, 59, true);

    // --- To-Do App JS ---
    const taskList = document.getElementById('task-list');
    const titleInput = document.getElementById('task-title');
    const dateInput = document.getElementById('task-date');
    const priorityInput = document.getElementById('task-priority');
    const recurringInput = document.getElementById('task-recurring');
    const addBtn = document.getElementById('add-task');
    const alarmSound = document.getElementById('alarm-sound');
    alarmSound.volume = 1.0;
    const filterPriority = document.getElementById('filter-priority');
    const filterDate = document.getElementById('filter-date');
    const darkToggle = document.getElementById('dark-toggle');

    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const notifiedTasks = new Set();

    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function getPriorityColor(priority) {
      return {
        low: 'bg-green-100 text-green-700',
        medium: 'bg-yellow-100 text-yellow-700',
        high: 'bg-red-100 text-red-700'
      }[priority] || '';
    }

    function renderTasks() {
      taskList.innerHTML = '';
      const filterP = filterPriority.value;
      const filterD = filterDate.value;

      tasks.forEach(task => {
        if ((filterP !== 'all' && task.priority !== filterP) ||
            (filterD && task.dueDate !== filterD)) return;

        const li = document.createElement('li');
        let isDark = document.documentElement.classList.contains('dark');
        if (task.completed && isDark) {
          li.className = 'flex justify-between items-start p-3 border rounded-xl shadow-sm task-completed-deepblue';
        } else if (task.completed) {
          li.className = 'flex justify-between items-start p-3 border rounded-xl shadow-sm bg-green-100 task-completed-deepblue';
        } else {
          li.className = 'flex justify-between items-start p-3 border rounded-xl shadow-sm bg-gray-50 dark:bg-gray-700';
        }

        const left = document.createElement('div');
        left.className = 'flex items-center gap-3 flex-wrap';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = task.completed;
        checkbox.className = 'form-checkbox h-5 w-5 text-blue-600';
        checkbox.onchange = () => {
          task.completed = !task.completed;
          saveTasks();
          renderTasks();
        };

        const span = document.createElement('span');
        if (task.completed) {
          span.className = 'completed-text';
        } else {
          span.className = 'text-gray-800 dark:text-white';
        }
        span.textContent = task.title;

        const dateSpan = document.createElement('span');
        dateSpan.className = 'text-xs text-gray-400';
        dateSpan.textContent = dayjs(task.dueDate).format('MMM D');

        const priorityBadge = document.createElement('span');
        priorityBadge.textContent = task.priority;
        priorityBadge.className = `text-xs px-2 py-1 rounded-full font-semibold ${getPriorityColor(task.priority)}`;

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'flex flex-col gap-1 mt-2';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded';
        editBtn.onclick = () => {
          const newTitle = prompt('Edit title:', task.title);
          const newDate = prompt('Edit due date:', task.dueDate);
          const newPriority = prompt('Edit priority (low, medium, high):', task.priority);
          if (newTitle && newDate && ['low', 'medium', 'high'].includes(newPriority)) {
            task.title = newTitle;
            task.dueDate = newDate;
            task.priority = newPriority;
            saveTasks();
            renderTasks();
          }
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded';
        delBtn.onclick = () => {
          tasks = tasks.filter(t => t.id !== task.id);
          saveTasks();
          renderTasks();
        };

        left.append(checkbox, span, dateSpan, priorityBadge);
        buttonGroup.append(editBtn, delBtn);
        li.append(left, buttonGroup);
        taskList.appendChild(li);
      });
    }

    addBtn.onclick = () => {
      const title = titleInput.value.trim();
      const dueDate = dateInput.value;
      const priority = priorityInput.value;
      const recurring = recurringInput.value;
      if (!title || !dueDate || !priority) return;
      const newTask = {
        id: crypto.randomUUID(),
        title,
        dueDate,
        completed: false,
        priority,
        recurring
      };
      tasks.push(newTask);
      titleInput.value = '';
      dateInput.value = '';
      priorityInput.value = 'low';
      recurringInput.value = 'none';
      saveTasks();
      renderTasks();
    };

    filterPriority.onchange = renderTasks;
    filterDate.onchange = renderTasks;

    darkToggle.onclick = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');

      if (!isDark) {
        setTimeout(() => {
          alert("Light Mode? Touching grass, unc?");
        }, 300);

        document.body.classList.add('invert');
        setTimeout(() => {
          document.body.classList.remove('invert');
        }, 700);
      }
      renderTasks();
    };

    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }

    function checkAlarms() {
      const today = dayjs().format('YYYY-MM-DD');
      tasks.forEach(task => {
        if (!task.completed && !notifiedTasks.has(task.id) && task.dueDate === today) {
          alarmSound.play();
          notifiedTasks.add(task.id);
          alert(`Reminder: ${task.title} is due today!`);

          if (task.recurring === 'daily') {
            task.dueDate = dayjs(task.dueDate).add(1, 'day').format('YYYY-MM-DD');
            notifiedTasks.delete(task.id);
          }
          if (task.recurring === 'weekly') {
            task.dueDate = dayjs(task.dueDate).add(7, 'day').format('YYYY-MM-DD');
            notifiedTasks.delete(task.id);
          }
        }
      });
      saveTasks();
      renderTasks();
    }

    setInterval(checkAlarms, 60 * 1000);
    renderTasks();

    // --- Right Sidebar Clock & Alarm JS ---
    function pad(num) { return num.toString().padStart(2, '0'); }
    function formatDateTimeLocal(dt) {
      if (!dt) return '';
      const date = new Date(dt);
      // CHANGED: dd-mm-yyyy format
      return (
        `${pad(date.getDate())}-${pad(date.getMonth() + 1)}-${date.getFullYear()} ` +
        `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`
      );
    }

    const alarmForm = document.getElementById('alarm-form');
    const alarmDateInput = document.getElementById('alarm-date');
    const alarmHourInput = document.getElementById('alarm-hour');
    const alarmMinuteInput = document.getElementById('alarm-minute');
    const alarmAmPmInput = document.getElementById('alarm-ampm');
    const alarmLabelInput = document.getElementById('alarm-label');
    const alarmListElem = document.getElementById('alarm-list');
    const alarmSaveBtn = document.getElementById('alarm-save-btn');
    const alarmCancelBtn = document.getElementById('alarm-cancel-btn');
    const currentTimeElem = document.getElementById('current-time');

    let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
    let editingAlarmIndex = null;

    function updateCurrentTime() {
      const now = new Date();
      currentTimeElem.textContent = formatDateTimeLocal(now);
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    function saveAlarms() {
      localStorage.setItem('alarms', JSON.stringify(alarms));
    }

    function setAlarmEditFields(dt) {
      alarmDateInput.value = dt.toISOString().slice(0, 10);
      let hour = dt.getHours();
      let ampm = 'AM';
      if (hour >= 12) {
        ampm = 'PM';
        if (hour > 12) hour -= 12;
      }
      if (hour === 0) hour = 12;
      alarmHourInput.value = String(hour);
      alarmMinuteInput.value = pad(dt.getMinutes());
      alarmAmPmInput.value = ampm;
    }

    function renderAlarms() {
      alarmListElem.innerHTML = '';
      if (alarms.length === 0) {
        alarmListElem.innerHTML = '<li class="text-gray-500 text-sm text-center">No alarms set.</li>';
        return;
      }
      alarms.forEach((alarm, idx) => {
        const dtStr = formatDateTimeLocal(alarm.datetime);
        const li = document.createElement('li');
        li.className = 'flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-2 rounded-lg bg-white dark:bg-gray-800 shadow border';
        li.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold">${alarm.label ? alarm.label : 'Alarm'}</div>
            <div class="text-xs text-gray-500">${dtStr}</div>
          </div>
          <div class="flex gap-1 mt-1 sm:mt-0">
            <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded edit-alarm-btn">Edit</button>
            <button class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded delete-alarm-btn">Delete</button>
          </div>
        `;
        // Edit
        li.querySelector('.edit-alarm-btn').onclick = () => {
          const dt = new Date(alarm.datetime);
          setAlarmEditFields(dt);
          alarmLabelInput.value = alarm.label || '';
          editingAlarmIndex = idx;
          alarmSaveBtn.textContent = "Update Alarm";
          alarmCancelBtn.classList.remove('hidden');
        };
        // Delete
        li.querySelector('.delete-alarm-btn').onclick = () => {
          alarms.splice(idx, 1);
          saveAlarms();
          renderAlarms();
        };
        alarmListElem.appendChild(li);
      });
    }
    renderAlarms();

    alarmForm.onsubmit = function(e) {
      e.preventDefault();
      const date = alarmDateInput.value;
      const hour = parseInt(alarmHourInput.value, 10);
      const minute = parseInt(alarmMinuteInput.value, 10);
      const ampm = alarmAmPmInput.value;

      if (!date) return;

      let hour24 = hour;
      if (ampm === 'PM' && hour24 < 12) hour24 += 12;
      if (ampm === 'AM' && hour24 === 12) hour24 = 0;

      const hourStr = String(hour24).padStart(2, '0');
      const minuteStr = String(minute).padStart(2, '0');
      const datetime = `${date}T${hourStr}:${minuteStr}:00`;

      const label = alarmLabelInput.value.trim();
      if (editingAlarmIndex !== null) {
        alarms[editingAlarmIndex] = { datetime, label };
        editingAlarmIndex = null;
        alarmSaveBtn.textContent = "Add Alarm";
        alarmCancelBtn.classList.add('hidden');
      } else {
        alarms.push({ datetime, label });
      }
      alarmForm.reset();
      renderAlarms();
      saveAlarms();
    };

    alarmCancelBtn.onclick = function() {
      editingAlarmIndex = null;
      alarmForm.reset();
      alarmSaveBtn.textContent = "Add Alarm";
      alarmCancelBtn.classList.add('hidden');
    };

    let alarmRangFor = {};
    setInterval(function() {
      const now = new Date();
      alarms.forEach((alarm, idx) => {
        const alarmTime = new Date(alarm.datetime);
        if (
          now.getFullYear() === alarmTime.getFullYear() &&
          now.getMonth() === alarmTime.getMonth() &&
          now.getDate() === alarmTime.getDate() &&
          now.getHours() === alarmTime.getHours() &&
          now.getMinutes() === alarmTime.getMinutes() &&
          Math.abs(now.getSeconds() - alarmTime.getSeconds()) < 2
        ) {
          if (!alarmRangFor[alarm.datetime]) {
            alarmRangFor[alarm.datetime] = true;
            alarmSound.play();
            setTimeout(() => { alarmRangFor[alarm.datetime] = false; }, 3500);
            alert(`⏰ Alarm! ${alarm.label ? alarm.label : ''}`);
          }
        }
      });
    }, 1000);

    setInterval(() => {
      Object.keys(alarmRangFor).forEach(dt => {
        if (Date.now() - new Date(dt).getTime() > 1000 * 3600) {
          delete alarmRangFor[dt];
        }
      });
    }, 60000);

    function setSidebarDarkMode() {
      const sidebar = document.getElementById('right-sidebar');
      if (document.documentElement.classList.contains('dark')) {
        sidebar.classList.add('dark', 'bg-gray-900', 'text-white');
        sidebar.classList.remove('bg-white', 'text-gray-900');
      } else {
        sidebar.classList.remove('dark', 'bg-gray-900', 'text-white');
        sidebar.classList.add('bg-white', 'text-gray-900');
      }
    }
    setSidebarDarkMode();
    new MutationObserver(setSidebarDarkMode).observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>
</html>